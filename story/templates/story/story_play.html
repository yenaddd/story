<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìŠ¤í† ë¦¬ ë¶„ê¸° ì²´í—˜ (V5 - í”Œë ˆì´)</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #5c6770; border-bottom: 2px solid #5c6770; padding-bottom: 10px; }
        .metadata { font-size: 0.9em; color: #777; margin-bottom: 20px; border-bottom: 1px dashed #ddd; padding-bottom: 10px; }
        .relationships { margin-top: 10px; padding: 10px; background-color: #e9ecef; border-radius: 4px; }
        .story-text { font-size: 1.1em; line-height: 1.6; white-space: pre-wrap; margin-bottom: 30px; }
        .choices-container { padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .choice-btn {
            display: block; width: 100%; padding: 10px; margin: 10px 0;
            background-color: #007bff; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-size: 1em;
            transition: background-color 0.2s;
        }
        .choice-btn:hover { background-color: #0056b3; }
        .ending { color: #dc3545; font-weight: bold; font-size: 1.2em; text-align: center; margin-top: 30px; }
        .error-link { margin-top: 20px; }
        .loading-message { color: #007bff; font-weight: bold; } 
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“œ ìŠ¤í† ë¦¬ í”Œë ˆì´</h1>
        
        <div style="text-align: right; margin-bottom: 15px;">
            <a href="{% url 'story-plot' %}" target="_blank" style="background-color: #64748b; color: white; padding: 8px 15px; text-decoration: none; border-radius: 6px; font-size: 0.9em;">
                ğŸ“– ì „ì²´ ì¤„ê±°ë¦¬(ì„¤ì •) ë³´ê¸°
            </a>
        </div>

        <div id="metadata" class="metadata"></div>

        <div id="story-content" class="story-text">ìŠ¤í† ë¦¬ë¥¼ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</div>
        
        <h2>ë‹¤ìŒ ê²°ì • (ë‹¹ì‹ ì˜ ì„ íƒ)</h2>
        <div id="choices-container" class="choices-container"></div>
    </div>

    <script>
        const API_BASE_URL = "/story/api/node/"; 
        const CREATOR_PAGE_URL = "/story/creator/"; 
        const urlParams = new URLSearchParams(window.location.search);
        let currentNodeId = parseInt(urlParams.get('node_id')) || 1;
        
        const MAX_RETRIES = 10; 
        const RETRY_DELAY_MS = 1000; 

        async function loadNode(nodeId, attempt = 1) {
            currentNodeId = nodeId;
            const contentDiv = document.getElementById('story-content');
            const choicesDiv = document.getElementById('choices-container');
            const metaDiv = document.getElementById('metadata');
            
            metaDiv.innerHTML = '';
            choicesDiv.innerHTML = '';
            
            contentDiv.innerHTML = `<span class="loading-message">ìŠ¤í† ë¦¬ ë¡œë”© ì¤‘... (ì‹œë„ ${attempt}/${MAX_RETRIES})</span>`;

            try {
                const url = `${API_BASE_URL}${nodeId}/`; 
                const response = await fetch(url);

                if (response.status === 404) {
                    if (nodeId === 1 && attempt < MAX_RETRIES) {
                        console.warn(`Node 1 ë¡œë“œ ì‹¤íŒ¨ (404): ${RETRY_DELAY_MS}ms í›„ ì¬ì‹œë„...`);
                        await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                        return await loadNode(nodeId, attempt + 1);
                    }
                    
                    contentDiv.innerHTML = `
                        <p>ì €ì¥ëœ ìŠ¤í† ë¦¬ê°€ ì—†ê±°ë‚˜, ë…¸ë“œ ID ${nodeId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        <div class="error-link">
                            <a href="${CREATOR_PAGE_URL}" style="color: #007bff; font-weight: bold;">ìƒˆ ìŠ¤í† ë¦¬ ìƒì„± í˜ì´ì§€ë¡œ ì´ë™</a>
                        </div>
                    `;
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`ë…¸ë“œ ë¡œë”© ì‹¤íŒ¨: HTTP ${response.status}`);
                }
                
                const nodeData = await response.json();
                displayNode(nodeData);

            } catch (error) {
                contentDiv.textContent = `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
            }
        }
        
        function displayNode(nodeData) {
            // 1. ë©”íƒ€ë°ì´í„° (ê´€ê³„, ì‹¬ë¦¬ í¬í•¨) í‘œì‹œ - [ìˆ˜ì •ë¨: ê°ì²´ íƒ€ì… ì²˜ë¦¬]
            let relHtml = '<ul>';
            const rels = nodeData.current_relationships || {};
            
            for (const [char, status] of Object.entries(rels)) {
                let statusText = status;
                // ë§Œì•½ statusê°€ ë¬¸ìì—´ì´ ì•„ë‹ˆê³  ê°ì²´ë¼ë©´ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ê±°ë‚˜ íŠ¹ì • í•„ë“œ ì¶”ì¶œ
                if (typeof status === 'object' && status !== null) {
                    statusText = JSON.stringify(status).replace(/"/g, '').replace(/[{}]/g, ''); 
                }
                relHtml += `<li><strong>${char}:</strong> ${statusText}</li>`;
            }
            relHtml += '</ul>';

            document.getElementById('metadata').innerHTML = `
                <p>ë…¸ë“œ ID: ${nodeData.id} | ê¹Šì´: ${nodeData.depth} | ë‹¨ê³„: ${nodeData.freytag_stage}</p>
                <p>ê°ë… AI í‰ê°€ ì ìˆ˜: ${nodeData.critique_score}ì  | <strong>ë‹¹ì‹ ì˜ ì‹¬ë¦¬ ìƒíƒœ</strong>: ${nodeData.protagonist_state}</p>
                <div class="relationships">
                    <strong>ì„œë¸Œ ìºë¦­í„° ê´€ê³„ í˜„í™©:</strong>
                    ${relHtml}
                </div>
            `;

            // 2. ìŠ¤í† ë¦¬ ë‚´ìš© í‘œì‹œ
            document.getElementById('story-content').textContent = nodeData.story_text;

            // 3. ì„ íƒì§€ ë²„íŠ¼ í‘œì‹œ
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = ''; 
            
            if (nodeData.choices && nodeData.choices.length > 0) {
                nodeData.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.innerHTML = `â†’ ${choice.choice_text}`;
                    button.onclick = () => loadNode(choice.next_node_id); 
                    choicesContainer.appendChild(button);
                });
            } else {
                choicesContainer.innerHTML = '<div class="ending">ğŸ‰ <strong>ì´ì•¼ê¸° ë! í•˜ë‚˜ì˜ ìµœì¢… ê²°ë§ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.</strong></div>';
            }
        }

        window.onload = () => {
            loadNode(currentNodeId); 
        };
    </script>
</body>
</html>